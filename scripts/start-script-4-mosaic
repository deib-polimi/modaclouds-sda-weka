#!/bin/bash

## chunk::dd0589220f7c9bd3c2b62f4e1edc9b95::begin ##
set -e -E -u -o pipefail -o noclobber -o noglob +o braceexpand || exit 1
trap 'printf "[ee] failed: %s\n" "${BASH_COMMAND}" >&2' ERR || exit 1

if test "$( getent passwd -- mos-services | cut -f 3 -d : )" -ne "${UID}" ; then
	exec sudo -u mos-services -g mos-services -E -n -- "${0}" "${@}"
	exit 1
fi

if ! test "${#}" -eq 0 ; then
	printf '[ii] invalid arguments; aborting!\n' >&2
	exit 1
fi

umask 0027

exec </dev/null >&2
## chunk::dd0589220f7c9bd3c2b62f4e1edc9b95::end ##

_variable_defaults=(
		
		_JAVA_SDA_DISTRIBUTION='/opt/modaclouds-services-${dist.file.name}-${project.version}/lib/distribution'
		_JAVA_SDA_ENDPOINT_IP=127.0.0.1
		_JAVA_SDA_ENDPOINT_PORT=8177
		
		_TOWER4CLOUDS_MANAGER_IP=127.0.0.1
		_TOWER4CLOUDS_MANAGER_PORT=8170
		
		_TOWER4CLOUDS_DC_SYNC_PERIOD=30
		_TOWER4CLOUDS_RESOURCES_KEEP_ALIVE_PERIOD=60
		
		_TOWER4CLOUDS_CLOUD_PROVIDER_ID='@{definitions:environment:TOWER4CLOUDS_CLOUD_PROVIDER_ID}'
		_TOWER4CLOUDS_CLOUD_PROVIDER_TYPE='@{definitions:environment:TOWER4CLOUDS_CLOUD_PROVIDER_TYPE}'
		_TOWER4CLOUDS_PAAS_SERVICE_ID='@{definitions:environment:TOWER4CLOUDS_PAAS_SERVICE_ID}'
		_TOWER4CLOUDS_PAAS_SERVICE_TYPE='@{definitions:environment:TOWER4CLOUDS_PAAS_SERVICE_TYPE}'
		_TOWER4CLOUDS_VM_ID='@{definitions:environment:TOWER4CLOUDS_VM_ID}'
		_TOWER4CLOUDS_VM_TYPE='@{definitions:environment:TOWER4CLOUDS_VM_TYPE}'
		_TOWER4CLOUDS_LOCATION_ID='@{definitions:environment:TOWER4CLOUDS_LOCATION_ID}'
		_TOWER4CLOUDS_LOCATION_TYPE='@{definitions:environment:TOWER4CLOUDS_LOCATION_TYPE}'
		_TOWER4CLOUDS_INTERNAL_COMPONENT_ID='@{definitions:environment:TOWER4CLOUDS_INTERNAL_COMPONENT_ID}'
		_TOWER4CLOUDS_INTERNAL_COMPONENT_TYPE='@{definitions:environment:TOWER4CLOUDS_INTERNAL_COMPONENT_TYPE}'
		
		_JAVA_HOME='/usr/lib64/jvm/jre'
		_PATH='/usr/lib64/jvm/jre/bin:/usr/bin:/bin'
		_TMPDIR='/tmp/modaclouds/${dist.file.name}'
)
declare "${_variable_defaults[@]}"

## chunk::fdccb2b60ff605167433bb1c89bd0b84::begin ##
export PATH="${_PATH}"

_identifier="${modaclouds_service_identifier:-0000000000000000000000000000000000000000}"

if test -n "${modaclouds_service_temporary:-}" ; then
	_TMPDIR="${modaclouds_service_temporary:-}"
elif test -n "${modaclouds_temporary:-}" ; then
	_TMPDIR="${modaclouds_temporary}/services/${_identifier}"
else
	_TMPDIR="${_TMPDIR}/${_identifier}"
fi
## chunk::fdccb2b60ff605167433bb1c89bd0b84::end ##

_variable_overrides=(
		
		_JAVA_SDA_DISTRIBUTION="${MODACLOUDS_JAVA_SDA_DISTRIBUTION:-${_JAVA_SDA_DISTRIBUTION}}"
		_JAVA_SDA_ENDPOINT_IP="${MODACLOUDS_JAVA_SDA_IP:-${_JAVA_SDA_ENDPOINT_IP}}"
		_JAVA_SDA_ENDPOINT_PORT="${MODACLOUDS_MONITORING_SDA_JAVA_ENDPOINT_PORT:-${_JAVA_SDA_ENDPOINT_PORT}}"
		
		_TOWER4CLOUDS_MANAGER_IP="${MODACLOUDS_TOWER4CLOUDS_MANAGER_IP:-${_TOWER4CLOUDS_MANAGER_IP}}"
		_TOWER4CLOUDS_MANAGER_PORT="${MODACLOUDS_TOWER4CLOUDS_MANAGER_PORT:-${_TOWER4CLOUDS_MANAGER_PORT}}"
		
		_TOWER4CLOUDS_DC_SYNC_PERIOD="${MODACLOUDS_TOWER4CLOUDS_DC_SYNC_PERIOD:-${_TOWER4CLOUDS_DC_SYNC_PERIOD}}"
		_TOWER4CLOUDS_RESOURCES_KEEP_ALIVE_PERIOD="${MODACLOUDS_TOWER4CLOUDS_RESOURCES_KEEP_ALIVE_PERIOD:-${_TOWER4CLOUDS_RESOURCES_KEEP_ALIVE_PERIOD}}"
		
		_TOWER4CLOUDS_CLOUD_PROVIDER_ID="${MODACLOUDS_TOWER4CLOUDS_CLOUD_PROVIDER_ID:-${_TOWER4CLOUDS_CLOUD_PROVIDER_ID}}"
		_TOWER4CLOUDS_CLOUD_PROVIDER_TYPE="${MODACLOUDS_TOWER4CLOUDS_CLOUD_PROVIDER_TYPE:-${_TOWER4CLOUDS_CLOUD_PROVIDER_TYPE}}"
		_TOWER4CLOUDS_PAAS_SERVICE_ID="${MODACLOUDS_TOWER4CLOUDS_PAAS_SERVICE_ID:-${_TOWER4CLOUDS_PAAS_SERVICE_ID}}"
		_TOWER4CLOUDS_PAAS_SERVICE_TYPE="${MODACLOUDS_TOWER4CLOUDS_PAAS_SERVICE_TYPE:-${_TOWER4CLOUDS_PAAS_SERVICE_TYPE}}"
		_TOWER4CLOUDS_VM_ID="${MODACLOUDS_TOWER4CLOUDS_VM_ID:-${_TOWER4CLOUDS_VM_ID}}"
		_TOWER4CLOUDS_VM_TYPE="${MODACLOUDS_TOWER4CLOUDS_VM_TYPE:-${_TOWER4CLOUDS_VM_TYPE}}"
		_TOWER4CLOUDS_LOCATION_ID="${MODACLOUDS_TOWER4CLOUDS_LOCATION_ID:-${_TOWER4CLOUDS_LOCATION_ID}}"
		_TOWER4CLOUDS_LOCATION_TYPE="${MODACLOUDS_TOWER4CLOUDS_LOCATION_TYPE:-${_TOWER4CLOUDS_LOCATION_TYPE}}"
		_TOWER4CLOUDS_INTERNAL_COMPONENT_ID="${MODACLOUDS_TOWER4CLOUDS_INTERNAL_COMPONENT_ID:-${_TOWER4CLOUDS_INTERNAL_COMPONENT_ID}}"
		_TOWER4CLOUDS_INTERNAL_COMPONENT_TYPE="${MODACLOUDS_TOWER4CLOUDS_INTERNAL_COMPONENT_TYPE:-${_TOWER4CLOUDS_INTERNAL_COMPONENT_TYPE}}"

		_JAVA_HOME="${MODACLOUDS_TOWER4CLOUDS_RDF_HISTORY_DB_JAVA_HOME:-${_JAVA_HOME}}"
		_PATH="${MODACLOUDS_TOWER4CLOUDS_RDF_HISTORY_DB_PATH:-${_PATH}}"
		_TMPDIR="${MODACLOUDS_TOWER4CLOUDS_RDF_HISTORY_DB_TMPDIR:-${_TMPDIR}}"
)
declare "${_variable_overrides[@]}"

## chunk::3a0efc2555cc97891ac1266f5065920a::begin ##
if test ! -e "${_TMPDIR}" ; then
	mkdir -p -- "${_TMPDIR}"
	mkdir -- "${_TMPDIR}/tmp"
	mkdir -- "${_TMPDIR}/home"
fi

exec {_lock}<"${_TMPDIR}"
if ! flock -x -n "${_lock}" ; then
	printf '[ee] failed to acquire lock; aborting!\n' >&2
	exit 1
fi

if test -d "${_TMPDIR}/cwd" ; then
	chmod -R u+w -- "${_TMPDIR}/cwd"
	rm -R -- "${_TMPDIR}/cwd"
fi
mkdir -- "${_TMPDIR}/cwd"

cd -- "${_TMPDIR}/cwd"

_environment=(
		PATH="${_PATH}"
		TMPDIR="${_TMPDIR}/tmp"
		HOME="${_TMPDIR}/home"
		USER='modaclouds-services'
)
## chunk::3a0efc2555cc97891ac1266f5065920a::end ##

_environment+=(
		
		MODACLOUDS_JAVA_SDA_IP="${_JAVA_SDA_ENDPOINT_IP}"
		MODACLOUDS_MONITORING_SDA_JAVA_ENDPOINT_PORT="${_JAVA_SDA_ENDPOINT_PORT}"
		
		MODACLOUDS_TOWER4CLOUDS_MANAGER_IP="${_TOWER4CLOUDS_MANAGER_IP}"
		MODACLOUDS_TOWER4CLOUDS_MANAGER_PORT="${_JAVA_SDA_ENDPOINT_PORT}"
		MODACLOUDS_TOWER4CLOUDS_DC_SYNC_PERIOD="${_TOWER4CLOUDS_DC_SYNC_PERIOD}"
		MODACLOUDS_TOWER4CLOUDS_RESOURCES_KEEP_ALIVE_PERIOD="${_TOWER4CLOUDS_RESOURCES_KEEP_ALIVE_PERIOD}"

		MODACLOUDS_TOWER4CLOUDS_CLOUD_PROVIDER_ID="${_TOWER4CLOUDS_CLOUD_PROVIDER_ID}"
		MODACLOUDS_TOWER4CLOUDS_CLOUD_PROVIDER_TYPE="${_TOWER4CLOUDS_CLOUD_PROVIDER_TYPE}"
		MODACLOUDS_TOWER4CLOUDS_PAAS_SERVICE_ID="${_TOWER4CLOUDS_PAAS_SERVICE_ID}"
		MODACLOUDS_TOWER4CLOUDS_PAAS_SERVICE_TYPE="${_TOWER4CLOUDS_PAAS_SERVICE_TYPE}"
		MODACLOUDS_TOWER4CLOUDS_VM_ID="${_TOWER4CLOUDS_VM_ID}"
		MODACLOUDS_TOWER4CLOUDS_VM_TYPE="${_TOWER4CLOUDS_VM_TYPE}"
		MODACLOUDS_TOWER4CLOUDS_LOCATION_ID="${_TOWER4CLOUDS_LOCATION_ID}"
		MODACLOUDS_TOWER4CLOUDS_LOCATION_TYPE="${_TOWER4CLOUDS_LOCATION_TYPE}"
		MODACLOUDS_TOWER4CLOUDS_INTERNAL_COMPONENT_ID="${_TOWER4CLOUDS_INTERNAL_COMPONENT_ID}"
		MODACLOUDS_TOWER4CLOUDS_INTERNAL_COMPONENT_TYPE="${_TOWER4CLOUDS_INTERNAL_COMPONENT_TYPE}"
)

printf '[--]\n' >&2
printf '[ii] parameters:\n' >&2
printf '[ii]   * monitoring SDA JAVA endpoint: `http://%s:%s/`;\n' "${_SDA_JAVA_ENDPOINT_IP}" "${_SDA_JAVA_ENDPOINT_PORT}" >&2
printf '[ii]   * monitoring DDA endpoint: `http://%s:%s/`;\n' "${_DDA_ENDPOINT_IP}" "${_DDA_ENDPOINT_PORT}" >&2
printf '[ii]   * knowledgebase endpoint: `http://%s:%s/`;\n' "${_KNOWLEDGEBASE_ENDPOINT_IP}" "${_KNOWLEDGEBASE_ENDPOINT_PORT}" >&2
printf '[ii]   * knowledgebase dataset: `%s`;\n' "${_KNOWLEDGEBASE_DATASET_PATH}" >&2
printf '[ii]   * knowledgebase sync-period: `%s`;\n' "${_KNOWLEDGEBASE_SYNC_PERIOD}" >&2
printf '[ii]   * environment:\n' >&2
for _variable in "${_environment[@]}" ; do
	printf '[ii]       * `%s`;\n' "${_variable}" >&2
done
printf '[ii]   * workding directory: `%s`;\n' "${PWD}" >&2
printf '[--]\n' >&2

printf '[ii] starting monitoring SDA JAVA...\n' >&2
printf '[--]\n' >&2

exec \
	env -i \
			"${_environment[@]}" \
	"${_JAVA_HOME}/bin/java" \
			-jar "${_SDA_JAVA_HOME}/service.jar" 
exit 1
